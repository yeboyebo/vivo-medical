!function(t,e){"function"==typeof define&&define.amd?define(e):t.BackgroundCheck=e()}(this,function(){"use strict";function d(){x=C=k=null,H={},g&&clearTimeout(g)}function m(t){b("debug")&&console.log(t)}function e(t,e){return i(t,typeof e),void 0===t?e:t}function i(t,e){if(void 0!==t&&typeof t!==e)throw"Incorrect attribute type"}function n(t,e){var i=t;if("string"==typeof t?i=document.querySelectorAll(t):t&&1===t.nodeType&&(i=[t]),!i||0===i.length||void 0===i.length)throw"Elements not found";return e&&(i=function(t){for(var e,i,n=[],o=0;o<t.length;o++)if(e=t[o],n.push(e),"IMG"!==e.tagName){if(1<(i=window.getComputedStyle(e).backgroundImage).split(/,url|, url/).length)throw"Multiple backgrounds are not supported";if(!i||"none"===i)throw"Element is not an <img> but does not have a background-image";n[o]={img:new Image,el:n[o]},i=(i=i.slice(4,-1)).replace(/"/g,""),m("CSS Image - "+(n[o].img.src=i))}return n}(i)),Array.prototype.slice.call(i)}function o(){b("debugOverlay")?(C.style.opacity=.5,C.style.pointerEvents="none",document.body.appendChild(C)):C.parentNode&&C.parentNode.removeChild(C)}function a(){W={left:0,top:0,right:document.body.clientWidth,bottom:window.innerHeight},C.width=document.body.clientWidth,C.height=window.innerHeight}function h(t,e,i){var n,o;return-1!==t.indexOf("px")?n=parseFloat(t):-1!==t.indexOf("%")?(n=(o=(n=parseFloat(t))/100)*e,i&&(n-=i*o)):n=e,n}function s(t){var e,i,n;if(t.nodeType){var o=t.getBoundingClientRect();e={left:o.left,right:o.right,top:o.top,bottom:o.bottom,width:o.width,height:o.height},n=t.parentNode,i=t}else e=function(t){var e=window.getComputedStyle(t.el);t.el.style.backgroundRepeat="no-repeat",t.el.style.backgroundOrigin="padding-box";var i=e.backgroundSize.split(" "),n=i[0],o=void 0===i[1]?"auto":i[1],a=t.el.clientWidth/t.el.clientHeight,r=t.img.naturalWidth/t.img.naturalHeight;"cover"===n?o=r<=a?(n="100%","auto"):(n="auto",i[0]="auto","100%"):"contain"===n&&(o=1/a<1/r?(n="auto",i[0]="auto","100%"):(n="100%","auto")),n="auto"===n?t.img.naturalWidth:h(n,t.el.clientWidth),o="auto"===o?n/t.img.naturalWidth*t.img.naturalHeight:h(o,t.el.clientHeight),"auto"===i[0]&&"auto"!==i[1]&&(n=o/t.img.naturalHeight*t.img.naturalWidth);var g,l,d=e.backgroundPosition;return"top"===d?d="50% 0%":"left"===d?d="0% 50%":"right"===d?d="100% 50%":"bottom"===d?d="50% 100%":"center"===d&&(d="50% 50%"),l=(l=4===(d=d.split(" ")).length?(g=d[1],d[3]):(g=d[0],d[1]))||"50%",g=h(g,t.el.clientWidth,n),l=h(l,t.el.clientHeight,o),4===d.length&&("right"===d[0]&&(g=t.el.clientWidth-t.img.naturalWidth-g),"bottom"===d[2]&&(l=t.el.clientHeight-t.img.naturalHeight-l)),g+=t.el.getBoundingClientRect().left,l+=t.el.getBoundingClientRect().top,{left:Math.floor(g),right:Math.floor(g+n),top:Math.floor(l),bottom:Math.floor(l+o),width:Math.floor(n),height:Math.floor(o)}}(t),n=t.el,i=t.img;n=n.getBoundingClientRect(),e.imageTop=0,e.imageLeft=0,e.imageWidth=i.naturalWidth,e.imageHeight=i.naturalHeight;var a,r=e.imageHeight/e.height;return e.top<n.top&&(a=n.top-e.top,e.imageTop=r*a,e.imageHeight-=r*a,e.top+=a,e.height-=a),e.left<n.left&&(a=n.left-e.left,e.imageLeft+=r*a,e.imageWidth-=r*a,e.width-=a,e.left+=a),e.bottom>n.bottom&&(a=e.bottom-n.bottom,e.imageHeight-=r*a,e.height-=a),e.right>n.right&&(a=e.right-n.right,e.imageWidth-=r*a,e.width-=a),e.imageTop=Math.floor(e.imageTop),e.imageLeft=Math.floor(e.imageLeft),e.imageHeight=Math.floor(e.imageHeight),e.imageWidth=Math.floor(e.imageWidth),e}function u(t,e,i){var n=t.className;switch(i){case"add":n+=" "+e;break;case"remove":var o=new RegExp("(?:^|\\s)"+e+"(?!\\S)","g");n=n.replace(o,"")}t.className=n.trim()}function c(t){for(var e,i=t?[t]:b("targets"),n=0;n<i.length;n++)e=i[n],u(e=b("changeParent")?e.parentNode:e,b("classes").light,"remove"),u(e,b("classes").dark,"remove"),u(e,b("classes").complex,"remove")}function f(t){var e,i,n,o=t.getBoundingClientRect(),a=0,r=0,g=0,l=0,d=b("mask");if(0<o.width&&0<o.height){c(t),t=b("changeParent")?t.parentNode:t,e=x.getImageData(o.left,o.top,o.width,o.height).data;for(var h=0;h<e.length;h+=4)e[h]===d.r&&e[h+1]===d.g&&e[h+2]===d.b?l++:(a++,r+=(i=.2126*e[h]+.7152*e[h+1]+.0722*e[h+2]-g)*i,g+=i/a);l<=e.length/4*(1-b("minOverlap")/100)&&(n=Math.sqrt(r/a)/255,g/=255,m("Target: "+t.className+" lum: "+g+" var: "+n),u(t,g<=b("threshold")/100?b("classes").dark:b("classes").light,"add"),n>b("minComplexity")/100&&u(t,b("classes").complex,"add"))}}function p(t,e){return t=(t.nodeType?t:t.el).getBoundingClientRect(),e=e===W?e:(e.nodeType?e:e.el).getBoundingClientRect(),!(t.right<e.left||t.left>e.right||t.top>e.bottom||t.bottom<e.top)}function v(t){for(var e,i=(new Date).getTime(),n=t&&("IMG"===t.tagName||t.img)?"image":"targets",o=!t,a=b("targets").length,r=0;r<a;r++)p(e=b("targets")[r],W)&&("targets"!==n||t&&t!==e?"image"===n&&p(e,t)&&f(e):(o=!0,f(e)));if("targets"===n&&!o)throw t+" is not a target";var g,l;g=i,m("Duration: "+(l=(new Date).getTime()-g)+"ms"),l>b("maxDuration")&&(console.log("BackgroundCheck - Killed"),c(),d())}function w(t){var e=function(t){var e=0;return"static"!==window.getComputedStyle(t).position&&(0<=(e=parseInt(window.getComputedStyle(t).zIndex,10)||0)&&e++),e},i=t.parentNode;return 1e5*(i?e(i):0)+e(t)}function y(t,e,i){if(k){var n=b("mask");m("--- BackgroundCheck ---"),m("onLoad event: "+(i&&i.src)),!0!==e&&(x.clearRect(0,0,C.width,C.height),x.fillStyle="rgb("+n.r+", "+n.g+", "+n.b+")",x.fillRect(0,0,C.width,C.height));for(var o,a,r=i?[i]:b("images"),g=function(t){var o=!1;return t.sort(function(t,e){t=t.nodeType?t:t.el,e=e.nodeType?e:e.el;var i=t.compareDocumentPosition(e),n=0;return t=w(t),(e=w(e))<t&&(o=!0),t===e&&2===i?n=1:t===e&&4===i&&(n=-1),n||t-e}),m("Sorted: "+o),o&&m(t),o}(r),l=!1,d=0;d<r.length;d++)p(o=r[d],W)&&(0===(a=o.nodeType?o:o.img).naturalWidth?(l=!0,m("Loading... "+o.src),a.removeEventListener("load",y),g?a.addEventListener("load",y.bind(null,null,!1,null)):a.addEventListener("load",y.bind(null,t,!0,o))):(m("Drawing: "+o.src),void 0,u=s(h=o),h=h.nodeType?h:h.img,0<u.imageWidth&&0<u.imageHeight&&0<u.width&&0<u.height?x.drawImage(h,u.imageLeft,u.imageTop,u.imageWidth,u.imageHeight,u.left,u.top,u.width,u.height):m("Skipping image - "+h.src+" - area too small")));i||l?i&&v(i):v(t)}var h,u}function r(t){!0===b("windowEvents")&&(g&&clearTimeout(g),g=setTimeout(t,200))}function b(t){if(void 0===H[t])throw"Unknown property - "+t;return H[t]}var k,C,x,g,W,l=void 0!==window.orientation?"orientationchange":"resize",H={};return{init:function(t){if(void 0===t||void 0===t.targets)throw"Missing attributes";H.debug=e(t.debug,!1),H.debugOverlay=e(t.debugOverlay,!1),H.targets=n(t.targets),H.images=n(t.images||"img",!0),H.changeParent=e(t.changeParent,!1),H.threshold=e(t.threshold,50),H.minComplexity=e(t.minComplexity,30),H.minOverlap=e(t.minOverlap,50),H.windowEvents=e(t.windowEvents,!0),H.maxDuration=e(t.maxDuration,500),H.mask=e(t.mask,{r:0,g:255,b:0}),H.classes=e(t.classes,{dark:"background--dark",light:"background--light",complex:"background--complex"}),void 0===k&&(k=!(!(C=document.createElement("canvas"))||!C.getContext||(x=C.getContext("2d"),0)),o(),k&&(C.style.position="fixed",C.style.top="0px",C.style.left="0px",C.style.width="100%",C.style.height="100%",window.addEventListener(l,r.bind(null,function(){a(),y()})),window.addEventListener("scroll",r.bind(null,y)),a(),y()))},destroy:d,refresh:y,set:function(t,e){if(void 0===H[t])throw"Unknown property - "+t;if(void 0===e)throw"Missing value for "+t;if("targets"===t||"images"===t)try{e=n("images"!==t||e?e:"img","images"===t)}catch(t){throw e=[],t}else i(e,typeof H[t]);c(),H[t]=e,y(),"debugOverlay"===t&&o()},get:b,getImageData:function(){for(var t,e=b("images"),i=[],n=0;n<e.length;n++)t=s(e[n]),i.push(t);return i}}});