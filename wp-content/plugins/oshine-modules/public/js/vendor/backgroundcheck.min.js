!function(t,e){"function"==typeof define&&define.amd?define(e):t.BackgroundCheck=e()}(this,function(){"use strict";function g(){k=b=y=null,H={},C&&clearTimeout(C)}function u(t){w("debug")&&console.log(t)}function e(t,e){return i(t,typeof e),void 0===t?e:t}function i(t,e){if(void 0!==t&&typeof t!==e)throw"Incorrect attribute type"}function n(t,e){var i=t;if("string"==typeof t?i=document.querySelectorAll(t):t&&1===t.nodeType&&(i=[t]),!i||0===i.length||void 0===i.length)throw"Elements not found";return e&&(i=function(t){for(var e,i=[],n=0;n<t.length;n++)if(e=t[n],i.push(e),"IMG"!==e.tagName){if(1<(e=window.getComputedStyle(e).backgroundImage).split(/,url|, url/).length)throw"Multiple backgrounds are not supported";if(!e||"none"===e)throw"Element is not an <img> but does not have a background-image";i[n]={img:new Image,el:i[n]},e=(e=e.slice(4,-1)).replace(/"/g,""),u("CSS Image - "+(i[n].img.src=e))}return i}(i)),Array.prototype.slice.call(i)}function o(){w("debugOverlay")?(b.style.opacity=.5,b.style.pointerEvents="none",document.body.appendChild(b)):b.parentNode&&b.parentNode.removeChild(b)}function a(){x={left:0,top:0,right:document.body.clientWidth,bottom:window.innerHeight},b.width=document.body.clientWidth,b.height=window.innerHeight}function l(t,e,i){var n;return-1!==t.indexOf("px")?n=parseFloat(t):-1!==t.indexOf("%")?(n=(t=(n=parseFloat(t))/100)*e,i&&(n-=i*t)):n=e,n}function m(t){var e,i;t=t.nodeType?(e={left:(i=t.getBoundingClientRect()).left,right:i.right,top:i.top,bottom:i.bottom,width:i.width,height:i.height},i=t.parentNode,t):(e=function(t){var e=window.getComputedStyle(t.el);t.el.style.backgroundRepeat="no-repeat",t.el.style.backgroundOrigin="padding-box";var i,n=e.backgroundSize.split(" "),o=n[0],a=void 0===n[1]?"auto":n[1],r=t.el.clientWidth/t.el.clientHeight,g=t.img.naturalWidth/t.img.naturalHeight;return"cover"===o?a=g<=r?(o="100%","auto"):(o="auto",n[0]="auto","100%"):"contain"===o&&(a=1/r<1/g?(o="auto",n[0]="auto","100%"):(o="100%","auto")),o="auto"===o?t.img.naturalWidth:l(o,t.el.clientWidth),a="auto"===a?o/t.img.naturalWidth*t.img.naturalHeight:l(a,t.el.clientHeight),"auto"===n[0]&&"auto"!==n[1]&&(o=a/t.img.naturalHeight*t.img.naturalWidth),"top"===(n=e.backgroundPosition)?n="50% 0%":"left"===n?n="0% 50%":"right"===n?n="100% 50%":"bottom"===n?n="50% 100%":"center"===n&&(n="50% 50%"),e=(e=4===(n=n.split(" ")).length?(i=n[1],n[3]):(i=n[0],n[1]))||"50%",i=l(i,t.el.clientWidth,o),e=l(e,t.el.clientHeight,a),4===n.length&&("right"===n[0]&&(i=t.el.clientWidth-t.img.naturalWidth-i),"bottom"===n[2]&&(e=t.el.clientHeight-t.img.naturalHeight-e)),i+=t.el.getBoundingClientRect().left,e+=t.el.getBoundingClientRect().top,{left:Math.floor(i),right:Math.floor(i+o),top:Math.floor(e),bottom:Math.floor(e+a),width:Math.floor(o),height:Math.floor(a)}}(t),i=t.el,t.img),i=i.getBoundingClientRect(),e.imageTop=0,e.imageLeft=0,e.imageWidth=t.naturalWidth,e.imageHeight=t.naturalHeight;var n,t=e.imageHeight/e.height;return e.top<i.top&&(n=i.top-e.top,e.imageTop=t*n,e.imageHeight-=t*n,e.top+=n,e.height-=n),e.left<i.left&&(n=i.left-e.left,e.imageLeft+=t*n,e.imageWidth-=t*n,e.width-=n,e.left+=n),e.bottom>i.bottom&&(n=e.bottom-i.bottom,e.imageHeight-=t*n,e.height-=n),e.right>i.right&&(n=e.right-i.right,e.imageWidth-=t*n,e.width-=n),e.imageTop=Math.floor(e.imageTop),e.imageLeft=Math.floor(e.imageLeft),e.imageHeight=Math.floor(e.imageHeight),e.imageWidth=Math.floor(e.imageWidth),e}function h(t,e,i){var n=t.className;switch(i){case"add":n+=" "+e;break;case"remove":e=new RegExp("(?:^|\\s)"+e+"(?!\\S)","g"),n=n.replace(e,"")}t.className=n.trim()}function s(t){for(var e,i=t?[t]:w("targets"),n=0;n<i.length;n++)e=i[n],h(e=w("changeParent")?e.parentNode:e,w("classes").light,"remove"),h(e,w("classes").dark,"remove"),h(e,w("classes").complex,"remove")}function d(t){var e,i,n=t.getBoundingClientRect(),o=0,a=0,r=0,g=0,l=w("mask");if(0<n.width&&0<n.height){s(t),t=w("changeParent")?t.parentNode:t,e=k.getImageData(n.left,n.top,n.width,n.height).data;for(var d=0;d<e.length;d+=4)e[d]===l.r&&e[d+1]===l.g&&e[d+2]===l.b?g++:(o++,a+=(i=.2126*e[d]+.7152*e[d+1]+.0722*e[d+2]-r)*i,r+=i/o);g<=e.length/4*(1-w("minOverlap")/100)&&(n=Math.sqrt(a/o)/255,r/=255,u("Target: "+t.className+" lum: "+r+" var: "+n),h(t,r<=w("threshold")/100?w("classes").dark:w("classes").light,"add"),n>w("minComplexity")/100&&h(t,w("classes").complex,"add"))}}function c(t,e){return t=(t.nodeType?t:t.el).getBoundingClientRect(),e=e===x?e:(e.nodeType?e:e.el).getBoundingClientRect(),!(t.right<e.left||t.left>e.right||t.top>e.bottom||t.bottom<e.top)}function f(t){for(var e,i=(new Date).getTime(),n=t&&("IMG"===t.tagName||t.img)?"image":"targets",o=!t,a=w("targets").length,r=0;r<a;r++)c(e=w("targets")[r],x)&&("targets"!=n||t&&t!==e?"image"==n&&c(e,t)&&d(e):(o=!0,d(e)));if("targets"==n&&!o)throw t+" is not a target";i=i,u("Duration: "+(i=(new Date).getTime()-i)+"ms"),i>w("maxDuration")&&(console.log("BackgroundCheck - Killed"),s(),g())}function p(t){function e(t){var e=0;return"static"!==window.getComputedStyle(t).position&&(0<=(e=parseInt(window.getComputedStyle(t).zIndex,10)||0)&&e++),e}var i=t.parentNode;return 1e5*(i?e(i):0)+e(t)}function v(t,e,i){if(y){var n=w("mask");u("--- BackgroundCheck ---"),u("onLoad event: "+(i&&i.src)),!0!==e&&(k.clearRect(0,0,b.width,b.height),k.fillStyle="rgb("+n.r+", "+n.g+", "+n.b+")",k.fillRect(0,0,b.width,b.height));for(var o=i?[i]:w("images"),a=(h=!1,(n=o).sort(function(t,e){t=t.nodeType?t:t.el,e=e.nodeType?e:e.el;var i=t.compareDocumentPosition(e),n=0;return t=p(t),(e=p(e))<t&&(h=!0),t===e&&2===i?n=1:t===e&&4===i&&(n=-1),n||t-e}),u("Sorted: "+h),h&&u(n),h),r=!1,g=0;g<o.length;g++)c(l=o[g],x)&&(0===(d=l.nodeType?l:l.img).naturalWidth?(r=!0,u("Loading... "+l.src),d.removeEventListener("load",v),a?d.addEventListener("load",v.bind(null,null,!1,null)):d.addEventListener("load",v.bind(null,t,!0,l))):(u("Drawing: "+l.src),d=void 0,d=m(l=l),l=l.nodeType?l:l.img,0<d.imageWidth&&0<d.imageHeight&&0<d.width&&0<d.height?k.drawImage(l,d.imageLeft,d.imageTop,d.imageWidth,d.imageHeight,d.left,d.top,d.width,d.height):u("Skipping image - "+l.src+" - area too small")));i||r?i&&f(i):f(t)}var l,d,h}function r(t){!0===w("windowEvents")&&(C&&clearTimeout(C),C=setTimeout(t,200))}function w(t){if(void 0===H[t])throw"Unknown property - "+t;return H[t]}var y,b,k,C,x,W=void 0!==window.orientation?"orientationchange":"resize",H={};return{init:function(t){if(void 0===t||void 0===t.targets)throw"Missing attributes";H.debug=e(t.debug,!1),H.debugOverlay=e(t.debugOverlay,!1),H.targets=n(t.targets),H.images=n(t.images||"img",!0),H.changeParent=e(t.changeParent,!1),H.threshold=e(t.threshold,50),H.minComplexity=e(t.minComplexity,30),H.minOverlap=e(t.minOverlap,50),H.windowEvents=e(t.windowEvents,!0),H.maxDuration=e(t.maxDuration,500),H.mask=e(t.mask,{r:0,g:255,b:0}),H.classes=e(t.classes,{dark:"background--dark",light:"background--light",complex:"background--complex"}),void 0===y&&(y=!(!(b=document.createElement("canvas"))||!b.getContext||(k=b.getContext("2d"),0)),o(),y&&(b.style.position="fixed",b.style.top="0px",b.style.left="0px",b.style.width="100%",b.style.height="100%",window.addEventListener(W,r.bind(null,function(){a(),v()})),window.addEventListener("scroll",r.bind(null,v)),a(),v()))},destroy:g,refresh:v,set:function(t,e){if(void 0===H[t])throw"Unknown property - "+t;if(void 0===e)throw"Missing value for "+t;if("targets"===t||"images"===t)try{e=n("images"!==t||e?e:"img","images"===t)}catch(t){throw e=[],t}else i(e,typeof H[t]);s(),H[t]=e,v(),"debugOverlay"===t&&o()},get:w,getImageData:function(){for(var t,e=w("images"),i=[],n=0;n<e.length;n++)t=m(e[n]),i.push(t);return i}}});